<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Disponibilidad P√°del</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc,
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDxDWzC5lvwrZIGofndj17u0YrhudAFSHM",
      authDomain: "padel-disponibilidad.firebaseapp.com",
      projectId: "padel-disponibilidad",
      storageBucket: "padel-disponibilidad.appspot.com",
      messagingSenderId: "1075366795430",
      appId: "1:1075366795430:web:d24e45368d70089dfb3c67",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const col = collection(db, "disponibilidades");

    const form = document.getElementById("form");
    const lista = document.getElementById("lista");
    const calendario = document.getElementById("calendario-visual");
    const btnPrev = document.getElementById("prev-month");
    const btnNext = document.getElementById("next-month");
    const mesAnyo = document.getElementById("mes-anyo");

    let currentYear, currentMonth;
    const nombresMeses = [
      "Enero",
      "Febrero",
      "Marzo",
      "Abril",
      "Mayo",
      "Junio",
      "Julio",
      "Agosto",
      "Septiembre",
      "Octubre",
      "Noviembre",
      "Diciembre",
    ];

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = form.nombre.value;
      const fecha = form.fecha.value;
      const turno = form.turno.value;

      if (!nombre || !fecha || !turno) return;

      await addDoc(col, { nombre, fecha, turno });
      form.reset();
    });

    function ajustarMesAnyo(year, month) {
      mesAnyo.textContent = `${nombresMeses[month]} ${year}`;
    }

    function cambiarMes(mesOffset) {
      currentMonth += mesOffset;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      } else if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      ajustarMesAnyo(currentYear, currentMonth);
      renderVisualCalendar(disponibilidadesGlobal, currentYear, currentMonth);
    }

    btnPrev.addEventListener("click", () => cambiarMes(-1));
    btnNext.addEventListener("click", () => cambiarMes(1));

    let disponibilidadesGlobal = {};

    onSnapshot(col, (snapshot) => {
      lista.innerHTML = "";
      disponibilidadesGlobal = {};
      snapshot.forEach((docu) => {
        const d = docu.data();
        const key = `${d.fecha}_${d.turno}`;
        if (!disponibilidadesGlobal[key]) disponibilidadesGlobal[key] = [];
        disponibilidadesGlobal[key].push(d.nombre);

        const item = document.createElement("li");
        item.textContent = `${d.nombre} - ${d.fecha} - ${d.turno}`;

        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è";
        delBtn.className = "ml-2 text-red-500 hover:text-red-700";
        delBtn.onclick = async () =>
          await deleteDoc(doc(db, "disponibilidades", docu.id));

        item.appendChild(delBtn);
        lista.appendChild(item);
      });

      if (!currentYear || !currentMonth) {
        const ahora = new Date();
        currentYear = ahora.getFullYear();
        currentMonth = ahora.getMonth();
      }
      ajustarMesAnyo(currentYear, currentMonth);
      renderVisualCalendar(disponibilidadesGlobal, currentYear, currentMonth);
    });

    function renderVisualCalendar(disponibilidades, year, month) {
      calendario.innerHTML = "";
      const diasEnMes = new Date(year, month + 1, 0).getDate();
      const primerDiaSemana = new Date(year, month, 1).getDay();

      const grid = document.createElement("div");
      grid.className = "grid grid-cols-7 gap-1 select-none";

      const nombresDias = ["Dom", "Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b"];
      nombresDias.forEach((d) => {
        const div = document.createElement("div");
        div.className = "text-center font-bold text-sm text-gray-700";
        div.textContent = d;
        grid.appendChild(div);
      });

      // Espacios vac√≠os antes del primer d√≠a
      for (let i = 0; i < primerDiaSemana; i++) {
        const espacio = document.createElement("div");
        espacio.className = "h-20 w-20";
        grid.appendChild(espacio);
      }

      for (let dia = 1; dia <= diasEnMes; dia++) {
        const fecha = `${year}-${String(month + 1).padStart(2, "0")}-${String(
          dia
        ).padStart(2, "0")}`;
        const ma√±anaKey = `${fecha}_ma√±ana`;
        const tardeKey = `${fecha}_tarde`;

        const m = disponibilidades[ma√±anaKey] || [];
        const t = disponibilidades[tardeKey] || [];

        const mColor =
          m.length >= 4
            ? "bg-green-500"
            : m.length === 3
            ? "bg-yellow-300"
            : "bg-gray-300";
        const tColor =
          t.length >= 4
            ? "bg-green-500"
            : t.length === 3
            ? "bg-yellow-300"
            : "bg-gray-300";

        const cell = document.createElement("div");
        cell.className =
          "relative w-20 h-20 border border-gray-400 rounded-md overflow-hidden";

        // N√∫mero del d√≠a arriba izquierda
        const diaTexto = document.createElement("div");
        diaTexto.className = "absolute top-0 left-0 text-xs text-gray-700 p-1 z-10";
        diaTexto.textContent = dia;
        cell.appendChild(diaTexto);

        // Tri√°ngulo de ma√±ana (superior izquierda)
        const topLeft = document.createElement("div");
        topLeft.className = `absolute inset-0 ${mColor} clip-top-left`;
        topLeft.title = `Ma√±ana: ${m.join(", ")}`;
        cell.appendChild(topLeft);

        // Tri√°ngulo de tarde (inferior derecha)
        const bottomRight = document.createElement("div");
        bottomRight.className = `absolute inset-0 ${tColor} clip-bottom-right`;
        bottomRight.title = `Tarde: ${t.join(", ")}`;
        cell.appendChild(bottomRight);

        grid.appendChild(cell);
      }

      calendario.appendChild(grid);
    }

    // Estilos para los tri√°ngulos que dividen el d√≠a
    const style = document.createElement("style");
    style.innerHTML = `
      .clip-top-left {
        clip-path: polygon(0 0, 100% 0, 0 100%);
        z-index: 1;
      }
      .clip-bottom-right {
        clip-path: polygon(100% 100%, 100% 0, 0 100%);
        z-index: 2;
      }
      @media (max-width: 640px) {
        .w-20 {
          width: 40px !important;
          height: 40px !important;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</head>

<body class="bg-green-50 p-4 font-sans max-w-screen-sm mx-auto">
  <h1 class="text-2xl font-bold mb-4 text-green-700 text-center">
    Disponibilidad para jugar al P√°del
  </h1>

  <form
    id="form"
    class="mb-4 grid grid-cols-1 sm:grid-cols-4 gap-2"
    autocomplete="off"
  >
    <select
      name="nombre"
      required
      class="border p-2 rounded"
      aria-label="Nombre del jugador"
    >
      <option value="">Selecciona jugador</option>
      <option value="Kakun">Kakun</option>
      <option value="Fany">Fany</option>
      <option value="Moni">Moni</option>
      <option value="Sara">Sara</option>
      <option value="Comod√≠n">Comod√≠n</option>
    </select>

    <input
      name="fecha"
      type="date"
      required
      class="border p-2 rounded"
      aria-label="Fecha"
    />
    <select
      name="turno"
      required
      class="border p-2 rounded"
      aria-label="Turno de juego"
    >
      <option value="">Ma√±ana o Tarde</option>
      <option value="ma√±ana">Ma√±ana</option>
      <option value="tarde">Tarde</option>
    </select>
    <button
      type="submit"
      class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
    >
      Guardar
    </button>
  </form>

  <div class="flex justify-center items-center gap-4 mb-2">
    <button
      id="prev-month"
      class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
      aria-label="Mes anterior"
    >
      ‚Üê
    </button>
    <div
      id="mes-anyo"
      class="font-semibold text-green-800 text-lg select-none"
      aria-live="polite"
    >
      <!-- Mes y a√±o -->
    </div>
    <button
      id="next-month"
      class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700"
      aria-label="Mes siguiente"
    >
      ‚Üí
    </button>
  </div>

  <h2 class="text-lg font-semibold mt-4">Disponibilidades registradas</h2>
  <ul id="lista" class="mb-6 list-disc list-inside max-h-48 overflow-auto"></ul>

  <h2 class="text-lg font-semibold mb-2">Calendario visual</h2>
  <div id="calendario-visual" class="overflow-x-auto"></div>
</body>

</html>
